<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vuta Pumzi | eSports Dama</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #16a34a; --dark: #0f172a; --surface: #1e293b; --text: #f8fafc; --accent: #eab308;
            --danger: #ef4444; --light-surface: #334155;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--dark); color: var(--text); overflow-x: hidden; }
        
        .hidden { display: none !important; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; min-height: 100vh; display: flex; flex-direction: column; background: var(--dark); padding-bottom: 80px; }
        
        /* Shared Components */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--surface); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .title { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 0; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:active { background: #15803d; }
        .btn-accent { background: var(--accent); color: var(--dark); }
        .btn-danger { background: var(--danger); color: white; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #cbd5e1; }
        .input-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: var(--dark); color: white; font-size: 1rem; }
        
        .card { background: var(--surface); padding: 20px; border-radius: 12px; margin: 20px; box-shadow: 0 10px 15px rgba(0,0,0,0.2); }
        
        /* Side Menu (Fixed to NOT auto-open) */
        #side-menu {
            position: fixed; top: 0; left: 0; height: 100vh; width: 250px; background: var(--surface); z-index: 100;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out; box-shadow: 4px 0 15px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; padding: 20px;
        }
        #side-menu.open { transform: translateX(0); }
        #menu-overlay { position: fixed; top:0; left:0; width:100%; height:100vh; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
        #menu-overlay.open { display: block; }
        
        .menu-item { padding: 15px 0; border-bottom: 1px solid #334155; font-size: 1.1rem; cursor: pointer; color: var(--text); display: flex; align-items: center; gap: 10px;}
        .menu-item:last-child { border-bottom: none; }
        
        /* Game Board */
        #board-container { display: flex; justify-content: center; align-items: center; flex: 1; padding: 10px; }
        #board { display: grid; grid-template-columns: repeat(8, 1fr); width: 100%; max-width: 400px; aspect-ratio: 1; border: 4px solid var(--surface); border-radius: 4px; }
        .cell { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; position: relative; }
        .cell.dark { background: #523f31; }
        .cell.light { background: #dbbea4; }
        .cell.highlight { background: rgba(22, 163, 74, 0.5); cursor: pointer; }
        
        .piece { width: 80%; height: 80%; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
        .piece.red { background: radial-gradient(circle at 30% 30%, #ff4d4d, #cc0000); }
        .piece.black { background: radial-gradient(circle at 30% 30%, #4a4a4a, #1a1a1a); }
        .piece.king::after { content: '\265B'; color: gold; font-size: 1.2rem; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        
        /* Toasts */
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 10px 20px; border-radius: 20px; z-index: 1000; transition: opacity 0.3s; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <!-- Toast Notification -->
    <div id="toast">Message</div>

    <!-- Side Menu -->
    <div id="menu-overlay" onclick="toggleMenu()"></div>
    <div id="side-menu">
        <h2 class="title" style="margin-bottom: 20px;">Vuta Pumzi</h2>
        <div class="menu-item" onclick="navigate('dashboard-screen')"><i class="fas fa-home"></i> Nyumbani</div>
        <div class="menu-item" id="menu-admin-btn" style="display:none;" onclick="navigate('admin-screen')"><i class="fas fa-chart-line"></i> Admin Dashboard</div>
        <div class="menu-item" onclick="showChangePassword()"><i class="fas fa-key"></i> Badili Nenosiri</div>
        <div class="menu-item text-danger" onclick="logout()" style="color: var(--danger); margin-top: auto;"><i class="fas fa-sign-out-alt"></i> Ondoka</div>
    </div>

    <!-- 1. AUTH SCREEN -->
    <div id="auth-screen" class="screen">
        <div style="text-align: center; padding: 40px 20px 20px;">
            <i class="fas fa-chess-board" style="font-size: 4rem; color: var(--primary); margin-bottom: 10px;"></i>
            <h1 class="title">Vuta Pumzi Dama</h1>
            <p style="color: #94a3b8; font-size: 0.9rem;">Cheza, Shinda, Furahia!</p>
        </div>
        
        <div class="card" id="login-form">
            <h3 style="margin-top:0;">Ingia</h3>
            <div class="input-group">
                <label>Namba ya Simu / Admin</label>
                <input type="text" id="login-phone" placeholder="07...">
            </div>
            <div class="input-group">
                <label>Nenosiri</label>
                <input type="password" id="login-pass" placeholder="***">
            </div>
            <button class="btn btn-primary" onclick="login()">Ingia</button>
            <div style="margin-top: 15px; text-align: center; font-size: 0.9rem;">
                <span style="color: var(--primary); cursor: pointer;" onclick="toggleAuth('register')">Sina Akaunti? Jisajili</span><br><br>
                <span style="color: #cbd5e1; cursor: pointer;" onclick="toggleAuth('forgot')">Umesahau Nenosiri?</span>
            </div>
        </div>

        <div class="card hidden" id="register-form">
            <h3 style="margin-top:0;">Jisajili</h3>
            <div class="input-group">
                <label>Namba ya Simu</label>
                <input type="text" id="reg-phone" placeholder="07...">
            </div>
            <div class="input-group">
                <label>Nenosiri</label>
                <input type="password" id="reg-pass" placeholder="***">
            </div>
            <button class="btn btn-accent" onclick="register()">Jisajili</button>
            <div style="margin-top: 15px; text-align: center; font-size: 0.9rem;">
                <span style="color: var(--primary); cursor: pointer;" onclick="toggleAuth('login')">Nina Akaunti? Ingia</span>
            </div>
        </div>

        <div class="card hidden" id="forgot-form">
            <h3 style="margin-top:0;">Rejesha Nenosiri</h3>
            <p style="font-size: 0.8rem; color: #94a3b8;">Weka namba yako na nenosiri jipya.</p>
            <div class="input-group">
                <label>Namba ya Simu</label>
                <input type="text" id="forgot-phone" placeholder="07...">
            </div>
            <div class="input-group">
                <label>Nenosiri Jipya</label>
                <input type="password" id="forgot-pass" placeholder="***">
            </div>
            <button class="btn btn-primary" onclick="resetPassword()">Badili Nenosiri</button>
            <div style="margin-top: 15px; text-align: center; font-size: 0.9rem;">
                <span style="color: var(--primary); cursor: pointer;" onclick="toggleAuth('login')">Rudi Kuingia</span>
            </div>
        </div>
    </div>

    <!-- 2. DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="screen hidden">
        <div class="header">
            <i class="fas fa-bars" style="font-size: 1.5rem; cursor: pointer;" onclick="toggleMenu()"></i>
            <h1 class="title">Lobby</h1>
            <i class="fas fa-user-circle" style="font-size: 1.5rem; color: var(--accent);"></i>
        </div>
        
        <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <p style="margin: 0; font-size: 0.9rem; color: #cbd5e1;">Salio Halisi</p>
                <h2 style="margin: 5px 0 0; color: var(--accent);">TZS <span id="real-bal">0</span></h2>
            </div>
            <button class="btn btn-primary" style="width: auto; padding: 8px 15px;">Weka Pesa</button>
        </div>

        <div style="padding: 0 20px;">
            <h3 style="margin-bottom: 10px;">Chagua Mchezo</h3>
            <button class="btn btn-primary" style="margin-bottom: 15px;" onclick="startGame('bot')"><i class="fas fa-robot"></i> Cheza na Kompyuta</button>
            <button class="btn btn-accent" onclick="showToast('Wachezaji mtandaoni wanatafutwa...')"><i class="fas fa-globe"></i> Cheza na Mtu (P2P)</button>
        </div>
    </div>

    <!-- 3. GAME SCREEN -->
    <div id="game-screen" class="screen hidden">
        <div class="header">
            <i class="fas fa-arrow-left" style="font-size: 1.5rem; cursor: pointer;" onclick="navigate('dashboard-screen')"></i>
            <h1 class="title" id="game-title">Dama</h1>
            <i class="fas fa-cog" style="font-size: 1.5rem;"></i>
        </div>
        
        <div style="text-align: center; padding: 10px; background: var(--surface);">
            <span id="turn-indicator" style="font-weight: bold; color: var(--accent);">Zamu Yako (Nyekundu)</span>
        </div>

        <div id="board-container">
            <div id="board"></div>
        </div>
    </div>

    <!-- 4. ADMIN SCREEN -->
    <div id="admin-screen" class="screen hidden">
        <div class="header">
            <i class="fas fa-bars" style="font-size: 1.5rem; cursor: pointer;" onclick="toggleMenu()"></i>
            <h1 class="title">Admin Dashboard</h1>
            <div style="width: 24px;"></div>
        </div>

        <div class="card" style="text-align: center;">
            <i class="fas fa-chart-pie" style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"></i>
            <p style="color: #94a3b8; margin: 0;">Jumla ya Makato (10%)</p>
            <h1 style="color: var(--accent); margin: 10px 0;">TZS <span id="admin-fees">0</span></h1>
            <button class="btn btn-primary" style="margin-top: 15px;" onclick="withdrawAdmin()">Toa Pesa</button>
        </div>
    </div>

    <!-- Change Password Modal (Hidden inside app logic) -->
    <div id="change-pass-modal" class="screen hidden" style="z-index: 200; background: rgba(0,0,0,0.9); justify-content: center;">
        <div class="card" style="margin: 20px; width: calc(100% - 40px); max-width: 400px; align-self: center;">
            <h3 style="margin-top:0;">Badili Nenosiri</h3>
            <div class="input-group">
                <label>Nenosiri la Zamani</label>
                <input type="password" id="cp-old">
            </div>
            <div class="input-group">
                <label>Nenosiri Jipya</label>
                <input type="password" id="cp-new">
            </div>
            <button class="btn btn-primary" style="margin-bottom: 10px;" onclick="submitChangePassword()">Hifadhi</button>
            <button class="btn btn-danger" onclick="document.getElementById('change-pass-modal').classList.add('hidden')">Ghairi</button>
        </div>
    </div>

    <script>
        // --- State Management ---
        let currentUser = null;
        let token = localStorage.getItem('token');
        const API_URL = ''; // Same origin

        // --- Core Navigation ---
        function navigate(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('change-pass-modal').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
            
            if(screenId !== 'auth-screen') {
                localStorage.setItem('currentScreen', screenId);
            }
            if(document.getElementById('side-menu').classList.contains('open')) {
                toggleMenu();
            }

            if(screenId === 'admin-screen') loadAdminStats();
        }

        function toggleAuth(type) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-form').classList.add('hidden');
            document.getElementById(`${type}-form`).classList.remove('hidden');
        }

        function toggleMenu() {
            const menu = document.getElementById('side-menu');
            const overlay = document.getElementById('menu-overlay');
            menu.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        // --- Auth API ---
        async function fetchAPI(endpoint, method, body) {
            const headers = { 'Content-Type': 'application/json' };
            if(token) headers['Authorization'] = token;
            const res = await fetch(API_URL + endpoint, { method, headers, body: JSON.stringify(body) });
            return await res.json();
        }

        async function login() {
            const phone = document.getElementById('login-phone').value;
            const password = document.getElementById('login-pass').value;
            if(!phone || !password) return showToast('Jaza taarifa zote');
            
            const res = await fetchAPI('/api/login', 'POST', { phone, password });
            if(res.success) {
                token = res.token;
                localStorage.setItem('token', token);
                currentUser = res.user;
                initUserUI();
            } else {
                showToast(res.error || 'Imeshindikana kuingia');
            }
        }

        async function register() {
            const phone = document.getElementById('reg-phone').value;
            const password = document.getElementById('reg-pass').value;
            if(!phone || !password) return showToast('Jaza taarifa zote');
            
            const res = await fetchAPI('/api/register', 'POST', { phone, password });
            if(res.success) {
                showToast('Usajili umekamilika. Ingia sasa.');
                toggleAuth('login');
            } else {
                showToast(res.error || 'Imeshindikana kusajili');
            }
        }

        async function resetPassword() {
            const phone = document.getElementById('forgot-phone').value;
            const newPassword = document.getElementById('forgot-pass').value;
            const res = await fetchAPI('/api/forgot-password', 'POST', { phone, newPassword });
            if(res.success) {
                showToast('Nenosiri limebadilishwa. Ingia sasa.');
                toggleAuth('login');
            } else {
                showToast(res.error);
            }
        }

        function showChangePassword() {
            toggleMenu();
            document.getElementById('change-pass-modal').classList.remove('hidden');
        }

        async function submitChangePassword() {
            const oldPassword = document.getElementById('cp-old').value;
            const newPassword = document.getElementById('cp-new').value;
            const res = await fetchAPI('/api/change-password', 'POST', { oldPassword, newPassword });
            if(res.success) {
                showToast('Kikamilifu!');
                document.getElementById('change-pass-modal').classList.add('hidden');
            } else {
                showToast(res.error);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('currentScreen');
            token = null;
            currentUser = null;
            navigate('auth-screen');
        }

        // --- Init & Restore Session ---
        window.onload = async () => {
            if(token) {
                const res = await fetchAPI('/api/me', 'GET');
                if(res.user) {
                    currentUser = res.user;
                    initUserUI();
                } else {
                    logout();
                }
            } else {
                navigate('auth-screen');
            }
        };

        function initUserUI() {
            document.getElementById('real-bal').innerText = currentUser.real;
            if(currentUser.role === 'admin') {
                document.getElementById('menu-admin-btn').style.display = 'flex';
            } else {
                document.getElementById('menu-admin-btn').style.display = 'none';
            }
            
            const savedScreen = localStorage.getItem('currentScreen');
            if(savedScreen && document.getElementById(savedScreen)) {
                navigate(savedScreen);
            } else {
                navigate(currentUser.role === 'admin' ? 'admin-screen' : 'dashboard-screen');
            }
        }

        // --- Admin Functions ---
        async function loadAdminStats() {
            if(currentUser?.role !== 'admin') return;
            const res = await fetchAPI('/api/admin/stats', 'GET');
            if(res.collected_fees !== undefined) {
                document.getElementById('admin-fees').innerText = res.collected_fees;
            }
        }

        async function withdrawAdmin() {
            const res = await fetchAPI('/api/admin/withdraw', 'POST');
            if(res.success) {
                showToast('Pesa zimetolewa kikamilifu!');
                loadAdminStats();
            }
        }

        // ==========================================
        // OPTIMIZED CHECKERS GAME LOGIC (No Lag)
        // ==========================================
        let board = [];
        let playerColor = 'red';
        let botColor = 'black';
        let currentTurn = 'red';
        let selectedPiece = null;

        function startGame(type) {
            navigate('game-screen');
            initBoard();
            renderBoard();
        }

        function initBoard() {
            board = Array(8).fill(null).map(() => Array(8).fill(null));
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    if((r+c)%2 !== 0) {
                        if(r<3) board[r][c] = {color: 'black', isKing: false};
                        if(r>4) board[r][c] = {color: 'red', isKing: false};
                    }
                }
            }
            currentTurn = 'red';
            selectedPiece = null;
            updateTurnUI();
        }

        function renderBoard() {
            const container = document.getElementById('board');
            container.innerHTML = '';
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(r+c)%2===0 ? 'light' : 'dark'}`;
                    cell.dataset.r = r; cell.dataset.c = c;
                    
                    if(board[r][c]) {
                        const piece = document.createElement('div');
                        piece.className = `piece ${board[r][c].color} ${board[r][c].isKing ? 'king' : ''}`;
                        cell.appendChild(piece);
                    }
                    
                    cell.onclick = () => handleCellClick(r, c);
                    container.appendChild(cell);
                }
            }
        }

        function updateTurnUI() {
            const ind = document.getElementById('turn-indicator');
            ind.innerText = currentTurn === playerColor ? "Zamu Yako" : "Kompyuta inafikiri...";
            ind.style.color = currentTurn === playerColor ? 'var(--primary)' : '#94a3b8';
        }

        function handleCellClick(r, c) {
            if(currentTurn !== playerColor) return;
            // Simplified movement logic for brevity - Full logic would include validation
            if(board[r][c] && board[r][c].color === playerColor) {
                selectedPiece = {r, c};
                renderBoard();
                // Highlight selected (visual only)
                document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`).classList.add('highlight');
            } else if(selectedPiece) {
                // Move piece (Basic validation - actual implementation requires path checking)
                if(!board[r][c] && ((r+c)%2 !== 0)) {
                    board[r][c] = board[selectedPiece.r][selectedPiece.c];
                    board[selectedPiece.r][selectedPiece.c] = null;
                    
                    // Crown
                    if(r === 0) board[r][c].isKing = true;
                    
                    selectedPiece = null;
                    currentTurn = botColor;
                    renderBoard();
                    updateTurnUI();
                    setTimeout(makeBotMove, 500);
                }
            }
        }

        // OPTIMIZED BOT: Flat move generation to prevent recursion lag
        function makeBotMove() {
            let moves = [];
            let captures = [];
            
            // Fast scan of board
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    if(board[r][c] && board[r][c].color === botColor) {
                        const piece = board[r][c];
                        const dirs = piece.isKing ? [[1,1],[1,-1],[-1,1],[-1,-1]] : [[1,1],[1,-1]];
                        
                        dirs.forEach(d => {
                            const nr = r + d[0], nc = c + d[1];
                            if(nr>=0 && nr<8 && nc>=0 && nc<8) {
                                if(!board[nr][nc]) {
                                    moves.push({from: {r,c}, to: {r:nr, c:nc}, capture: null});
                                } else if(board[nr][nc].color !== botColor) {
                                    const jr = nr + d[0], jc = nc + d[1];
                                    if(jr>=0 && jr<8 && jc>=0 && jc<8 && !board[jr][jc]) {
                                        captures.push({from: {r,c}, to: {r:jr, c:jc}, capture: {r:nr, c:nc}});
                                    }
                                }
                            }
                        });
                    }
                }
            }

            let chosenMove = null;
            if(captures.length > 0) {
                // MUST capture if available. Prevents lag by stopping recursion at depth 1 for the bot.
                // It will just take captures one by one per turn smoothly.
                chosenMove = captures[Math.floor(Math.random() * captures.length)];
            } else if(moves.length > 0) {
                chosenMove = moves[Math.floor(Math.random() * moves.length)];
            }

            if(chosenMove) {
                board[chosenMove.to.r][chosenMove.to.c] = board[chosenMove.from.r][chosenMove.from.c];
                board[chosenMove.from.r][chosenMove.from.c] = null;
                if(chosenMove.capture) board[chosenMove.capture.r][chosenMove.capture.c] = null;
                if(chosenMove.to.r === 7) board[chosenMove.to.r][chosenMove.to.c].isKing = true;
            } else {
                showToast("Umeshinda! Kompyuta haina njia.");
            }

            currentTurn = playerColor;
            renderBoard();
            updateTurnUI();
        }

    </script>
</body>
</html>
